<!doctype html>
<html class="no-js">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" charset="UTF-8">
    <title>callbackFlow</title><meta name="robots" content="noindex, nofollow">
<link href="../../images/logo-icon.svg" rel="icon" type="image/svg"><script>var pathToRoot = "../../";</script>
    <script>document.documentElement.classList.replace("no-js","js");</script>    <script>const storage = localStorage.getItem("dokka-dark-mode")
    if (storage == null) {
        const osDarkSchemePreferred = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
        if (osDarkSchemePreferred === true) {
            document.getElementsByTagName("html")[0].classList.add("theme-dark")
        }
    } else {
        const savedDarkMode = JSON.parse(storage)
        if(savedDarkMode === true) {
            document.getElementsByTagName("html")[0].classList.add("theme-dark")
        }
    }
    </script>
<script type="text/javascript" src="../../scripts/sourceset_dependencies.js" async></script>
<link href="../../styles/style.css" rel="Stylesheet">
<link href="../../styles/main.css" rel="Stylesheet">
<link href="../../styles/prism.css" rel="Stylesheet">
<link href="../../styles/logo-styles.css" rel="Stylesheet">
<script type="text/javascript" src="../../scripts/clipboard.js" async></script>
<script type="text/javascript" src="../../scripts/navigation-loader.js" async></script>
<script type="text/javascript" src="../../scripts/platform-content-handler.js" async></script>
<script type="text/javascript" src="../../scripts/main.js" defer></script>
<script type="text/javascript" src="../../scripts/prism.js" async></script>
<script type="text/javascript" src="../../scripts/symbol-parameters-wrapper_deferred.js" defer></script></head>
<body>
    <div class="root">
<nav class="navigation" id="navigation-wrapper">
    <div class="navigation--inner">
        <div class="navigation-title">
            <button class="menu-toggle" id="menu-toggle" type="button">toggle menu</button>
            <div class="library-name">
<a class="library-name--link" href="../../index.html">
                            kotlinx.coroutines
                    </a>            </div>
            <div class="library-version">1.7.1
            </div>
        </div>
        <div class="filter-section" id="filter-section">
                <button class="platform-tag platform-selector common-like" data-active="" data-filter=":kotlinx-coroutines-core:dokkaHtmlPartial/commonMain">common</button>
        </div>
    </div>
    <div class="navigation-controls">
        <button class="navigation-controls--btn navigation-controls--theme" id="theme-toggle-button" type="button">switch theme</button>
        <div class="navigation-controls--btn navigation-controls--search" id="searchBar" role="button">search in API</div>
    </div>
</nav>
        <div id="container">
            <div class="sidebar" id="leftColumn">
                <div class="sidebar--inner" id="sideMenu"></div>
            </div>
            <div id="main">
<div class="main-content" data-page-type="member" id="content" pageids="kotlinx-coroutines-core::kotlinx.coroutines.flow//callbackFlow/#kotlin.coroutines.SuspendFunction1[kotlinx.coroutines.channels.ProducerScope[TypeParam(bounds=[kotlin.Any?])],kotlin.Unit]/PointingToDeclaration//1975948010">
  <div class="breadcrumbs"><a href="../index.html">kotlinx-coroutines-core</a><span class="delimiter">/</span><a href="index.html">kotlinx.coroutines.flow</a><span class="delimiter">/</span><span class="current">callbackFlow</span></div>
  <div class="cover ">
    <h1 class="cover"><span>callback</span><wbr><span><span>Flow</span></span></h1>
  </div>
  <div class="platform-hinted " data-platform-hinted="data-platform-hinted"><div class="content sourceset-dependent-content" data-active="" data-togglable=":kotlinx-coroutines-core:dokkaHtmlPartial/commonMain"><div class="symbol monospace"><span class="token keyword"></span><span class="token keyword">fun </span><span class="token operator">&lt;</span><span class="token keyword"></span><a href="callback-flow.html">T</a><span class="token operator">&gt; </span><a href="callback-flow.html"><span class="token function">callbackFlow</span></a><span class="token punctuation">(</span><span class="parameters "><span class="parameter ">block<span class="token operator">: </span><span class="token keyword">suspend </span><span class="token keyword"></span><a href="../kotlinx.coroutines.channels/-producer-scope/index.html">ProducerScope</a><span class="token operator">&lt;</span><span class="token keyword"></span><a href="callback-flow.html">T</a><span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator"> -&gt; </span><span class="token keyword"></span><a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin/-unit/index.html">Unit</a></span></span><span class="token punctuation">)</span><span class="token operator">: </span><a href="-flow/index.html">Flow</a><span class="token operator">&lt;</span><span class="token keyword"></span><a href="callback-flow.html">T</a><span class="token operator">&gt;</span><span class="clearfix"><span class="floating-right">(<a href="https://github.com/kotlin/kotlinx.coroutines/tree/master/kotlinx-coroutines-core/common/src/flow/Builders.kt#L307">source</a>)</span></span></div><p class="paragraph">Creates an instance of a <i>cold</i> <a href="-flow/index.html">Flow</a> with elements that are sent to a <a href="../kotlinx.coroutines.channels/-send-channel/index.html">SendChannel</a> provided to the builder's <a href="callback-flow.html">block</a> of code via <a href="../kotlinx.coroutines.channels/-producer-scope/index.html">ProducerScope</a>. It allows elements to be produced by code that is running in a different context or concurrently.</p><p class="paragraph">The resulting flow is <i>cold</i>, which means that <a href="callback-flow.html">block</a> is called every time a terminal operator is applied to the resulting flow.</p><p class="paragraph">This builder ensures thread-safety and context preservation, thus the provided <a href="../kotlinx.coroutines.channels/-producer-scope/index.html">ProducerScope</a> can be used from any context, e.g. from a callback-based API. The resulting flow completes as soon as the code in the <a href="callback-flow.html">block</a> completes. <a href="../kotlinx.coroutines.channels/await-close.html">awaitClose</a> should be used to keep the flow running, otherwise the channel will be closed immediately when block completes. <a href="../kotlinx.coroutines.channels/await-close.html">awaitClose</a> argument is called either when a flow consumer cancels the flow collection or when a callback-based API invokes <a href="../kotlinx.coroutines.channels/-send-channel/close.html">SendChannel.close</a> manually and is typically used to cleanup the resources after the completion, e.g. unregister a callback. Using <a href="../kotlinx.coroutines.channels/await-close.html">awaitClose</a> is mandatory in order to prevent memory leaks when the flow collection is cancelled, otherwise the callback may keep running even when the flow collector is already completed. To avoid such leaks, this method throws <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin/-illegal-state-exception/index.html">IllegalStateException</a> if block returns, but the channel is not closed yet.</p><p class="paragraph">A channel with the <a href="../kotlinx.coroutines.channels/-channel/-factory/-b-u-f-f-e-r-e-d.html">default</a> buffer size is used. Use the <a href="buffer.html">buffer</a> operator on the resulting flow to specify a user-defined value and to control what happens when data is produced faster than consumed, i.e. to control the back-pressure behavior.</p><p class="paragraph">Adjacent applications of <a href="callback-flow.html">callbackFlow</a>, <a href="flow-on.html">flowOn</a>, <a href="buffer.html">buffer</a>, and <a href="produce-in.html">produceIn</a> are always fused so that only one properly configured channel is used for execution.</p><p class="paragraph">Example of usage that converts a multi-shot callback API to a flow. For single-shot callbacks use <a href="../kotlinx.coroutines/suspend-cancellable-coroutine.html">suspendCancellableCoroutine</a>.</p><div class="sample-container"><pre><code class="block lang-kotlin" theme="idea">fun flowFrom(api: CallbackBasedApi): Flow&lt;T&gt; = callbackFlow {<br>    val callback = object : Callback { // Implementation of some callback interface<br>        override fun onNextValue(value: T) {<br>            // To avoid blocking you can configure channel capacity using<br>            // either buffer(Channel.CONFLATED) or buffer(Channel.UNLIMITED) to avoid overfill<br>            trySendBlocking(value)<br>                .onFailure { throwable -&gt;<br>                    // Downstream has been cancelled or failed, can log here<br>                }<br>        }<br>        override fun onApiError(cause: Throwable) {<br>            cancel(CancellationException("API Error", cause))<br>        }<br>        override fun onCompleted() = channel.close()<br>    }<br>    api.register(callback)<br>    /*<br>     * Suspends until either 'onCompleted'/'onApiError' from the callback is invoked<br>     * or flow collector is cancelled (e.g. by 'take(1)' or because a collector's coroutine was cancelled).<br>     * In both cases, callback will be properly unregistered.<br>     */<br>        awaitClose { api.unregister(callback) }<br>    }</code></pre><span class="top-right-position"><span class="copy-icon"></span><div class="copy-popup-wrapper popup-to-left"><span class="copy-popup-icon"></span><span>Content copied to clipboard</span></div></span></div><blockquote class="quotation"><p class="paragraph">The callback <code class="lang-kotlin">register</code>/<code class="lang-kotlin">unregister</code> methods provided by an external API must be thread-safe, because <code class="lang-kotlin">awaitClose</code> block can be called at any time due to asynchronous nature of cancellation, even concurrently with the call of the callback.</p></blockquote></div></div>
</div>
      <div class="footer">
        <span class="go-to-top-icon"><a href="#content" id="go-to-top-link"></a></span><span>© 2023 Copyright</span><span class="pull-right"><span>Generated by </span><a href="https://github.com/Kotlin/dokka"><span>dokka</span><span class="padded-icon"></span></a></span>
      </div>
            </div>
        </div>
    </div>
</body>
</html>

